#' Request metadata for all datasets in specified workspace
#'
#' @param workspace Name of the workspace containing datasets
#' @param powerbi_token AzureAuth token object generated by `get_powerbi_token()`
#'
#' @return DataFrame containing the names, GUIDs, and descriptions for all datasets in workspace
#' @export
list_datasets <- function(workspace, powerbi_token) {
  workspace_metadata <- list_workspaces(powerbi_token)
  if (!(workspace %in% workspace_metadata$Workspace)) {
    stop("No workspace called: ", workspace, " in tenant!", call. = FALSE)
  }

  base_url <- "https://api.powerbi.com/v1.0/myorg/groups/"
  workspace_id <- workspace_metadata[workspace_metadata$Workspace == workspace,]$WorkspaceId
  workspace_request <-  httr::GET(url = paste0(base_url, workspace_id, "/datasets"),
                                  config = get_auth_header(powerbi_token),
                                  httr::content_type_json())

  if (workspace_request$status_code != 200) {
    stop("API request returned status code: ", workspace_request$status_code, "!",
         call. = TRUE)
  }

  metadata_content <- httr::content(workspace_request)$value

  content_to_dataframe <- purrr::map_dfr(metadata_content, \(metadata){
    do.call(data.frame, purrr::keep(metadata, \(x){length(x) > 0}))
  })
  content_to_dataframe$Workspace <- workspace
  content_to_dataframe$WorkspaceId <- workspace_id

  content_to_dataframe <- content_to_dataframe[,c("Workspace", "WorkspaceId", "name", "id", "configuredBy")]
  names(content_to_dataframe) <- c("Workspace", "WorkspaceId", "Dataset", "DatasetId", "DatasetOwner")
  content_to_dataframe
}

#' Download a specified dataset table into R using the XMLA API endpoint. This
#' is a convenience wrapper around the the `execute_xmla_query()` function.
#'
#' @param workspace Name of the workspace containing dataflow
#' @param dataset Name of the dataset containing table
#' @param table Name of the table to download
#' @param powerbi_token AzureAuth token object generated by `get_powerbi_token()`
#'
#' @return DataFrame containing downloaded table
#' @export
get_dataset_table_xmla <- function(workspace, dataset, table,
                                   powerbi_token = get_powerbi_token(application_id = "23d8f6bd-1eb0-4cc2-a08c-7bf525c67bcd")) {
  query <- paste0("EVALUATE(", table, ")")
  table_query <- execute_xmla_query(workspace, dataset, query, powerbi_token)
  names(table_query) <- gsub(paste0(table, "\\[|\\]"), "", names(table_query))
  table_query
}

#' Execute a DAX query against a specified PowerBI Dataset using the XMLA API
#' endpoint.
#'
#' @param workspace Name of the workspace containing dataflow
#' @param dataset Name of the dataset to execute query against
#' @param query DAX query to execute
#' @param powerbi_token AzureAuth token object generated by `get_powerbi_token()`
#'
#' @return DataFrame containing results of query
#' @export
execute_xmla_query <- function(workspace, dataset, query, powerbi_token) {
  workspace_metadata <- list_workspaces(powerbi_token)
  target_workspace <- workspace_metadata[workspace_metadata$Workspace == workspace, ]

  capacity_id <- target_workspace$CapacityID
  capacity_uri <- target_workspace$CapacityUri
  workspace_id <- target_workspace$WorkspaceId

  capacity_region <- gsub("(pbidedicated://)(.*).pbidedicated.windows.net(.*)", "\\2", capacity_uri)
  xmla_server <- get_xmla_server(capacity_region, capacity_id, powerbi_token)
  xmla_token <- get_xmla_token(capacity_id, workspace_id, powerbi_token)

  xmla_url <- paste0("https://", xmla_server$clusterFQDN, "/webapi/xmla")
  xmla_auth <- httr::add_headers(Authorization = paste("MwcToken", xmla_token))
  xmla_body <- glue::glue('
    <Envelope xmlns="http://schemas.xmlsoap.org/soap/envelope/">
    <Header>
      <BeginSession soap:mustUnderstand="1" xmlns:soap="http://schemas.xmlsoap.org/soap/envelope/" xmlns="urn:schemas-microsoft-com:xml-analysis" />
      <Version Sequence="922" xmlns="http://schemas.microsoft.com/analysisservices/2003/engine/2" />
    </Header>
    <Body>
      <Execute xmlns="urn:schemas-microsoft-com:xml-analysis">
        <Command><Statement>{query}</Statement></Command>
        <Properties>
          <PropertyList>
            <Catalog>{dataset}</Catalog>
            <Format>Tabular</Format>
          </PropertyList>
        </Properties>
      </Execute>
    </Body>
  </Envelope>')

  xmla_request <- httr::POST(url = xmla_url,
                             config = xmla_auth,
                             body = as.character(xmla_body),
                             httr::add_headers(.headers = c(
                               "x-ms-xmlaserver"=xmla_server$coreServerName,
                               "x-ms-xmlacaps-negotiation-flags"="0,0,0,1,1",
                               "Content-Type"="text/xml",
                               "x-ms-request-registration-id"=uuid::UUIDgenerate(),
                               "x-ms-xmlaclienttraits"=1,
                               "x-ms-xmladedicatedconnection"=0,
                               "x-ms-accepts-continuations"=1,
                               "x-ms-round-trip-id"=0
                             ))
  )
  request_results <- httr::content(xmla_request, type="text/xml", encoding = "UTF-8")
  rowset_to_df(request_results)
}
